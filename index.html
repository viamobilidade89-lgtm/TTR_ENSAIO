<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENSAIOS ALPHA</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #38bdf8; --accent: #818cf8;
            --success: #10b981; --error: #f43f5e; --text: #f1f5f9; --border: rgba(255,255,255,0.1);
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header e T√≠tulo */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 2px solid var(--primary); margin-bottom: 20px; }
        .titulo-principal { color: var(--primary); margin: 0; font-size: 1.6em; font-weight: 800; letter-spacing: 2px; }

        /* Cards e Layout */
        .glass { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .nav-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .btn-nav { background: var(--card); border: 1px solid var(--border); color: white; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; text-align: center; }
        .btn-nav:hover { border-color: var(--primary); background: rgba(56, 189, 248, 0.1); }

        /* Inputs e Tabelas */
        label { display: block; font-size: 0.7rem; color: var(--primary); margin-bottom: 5px; text-transform: uppercase; font-weight: 700; }
        input, select { width: 100%; padding: 10px; background: #0a0f18; border: 1px solid #334155; color: white; border-radius: 6px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85em; }
        th, td { border: 1px solid #334155; padding: 10px; text-align: center; }
        th { background: #0a0f18; color: var(--primary); }

        /* Status Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: 800; font-size: 0.7em; }
        .ok { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .nok { background: rgba(244, 63, 94, 0.2); color: var(--error); }

        .btn-acao { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        .no-print { display: block; }

        @media print {
            .no-print, .btn-nav, button { display: none !important; }
            body { background: white; color: black; }
            .glass { border: 1px solid #000; background: white; color: black; display: block !important; }
            th { background: #eee !important; color: black !important; }
            .titulo-principal { color: black; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 class="titulo-principal">ENSAIOS ALPHA</h1>
        <div class="no-print">
            <button onclick="abrirS('CONFIG')" style="background:none; border:none; color:white; font-size:1.2em; cursor:pointer;">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="glass" id="headerDados">
        <div class="grid">
            <div><label>T√©cnico</label><select id="regTec" class="setTec"></select></div>
            <div><label>Localiza√ß√£o</label><select id="regLoc" class="setLoc"></select></div>
            <div><label>Equipamento / TAG</label><input type="text" id="regTag" placeholder="Ex: TRAFO-01"></div>
            <div><label>Data</label><input type="date" id="regData"></div>
        </div>
    </div>

    <div class="nav-menu no-print">
        <div class="btn-nav" onclick="abrirS('TTR')">‚ö° TTR</div>
        <div class="btn-nav" onclick="abrirS('MEG')">üõ°Ô∏è MEG√îMETRO</div>
        <div class="btn-nav" onclick="abrirS('MIC')">üîç MICRO</div>
        <div class="btn-nav" onclick="abrirS('HIST')" style="color:var(--primary)">üìú HIST√ìRICO</div>
    </div>

    <div id="secTTR" class="glass section" style="display:none;">
        <div class="grid">
            <div><label>U1 (V)</label><input type="number" id="u1" oninput="calcTTR()"></div>
            <div><label>U2 (V)</label><input type="number" id="u2" oninput="calcTTR()"></div>
            <div>
                <label>Fasorial</label>
                <select id="fasTTR" onchange="initTTR()">
                    <option value="">-- Selecione --</option>
                    <option value="Ydn1_11_X0">Ydn1/Ydn11 (C/ X0)</option>
                    <option value="Dyn1_11_X0">Dyn1/Dyn11 (C/ X0)</option>
                    <option value="Ynyn0">Ynyn0 (Direto)</option>
                    <option value="Yyn0_Dd0">Yyn0 ou Dd0</option>
                </select>
            </div>
        </div>
        <div id="teoResult" style="text-align:center; margin:15px; font-weight:bold; color:var(--primary);"></div>
        <table>
            <thead><tr><th>Bornes</th><th>Medido</th><th>Desvio %</th><th>Status</th></tr></thead>
            <tbody id="corpoTTR"></tbody>
        </table>
    </div>

    <div id="secMEG" class="glass section" style="display:none;">
        <div class="grid">
            <div><label>Ponto</label><input type="text" id="megP" placeholder="Ex: PRI x SEC"></div>
            <div>
                <label>Valor Medido</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="megV" style="flex:2;">
                    <select id="megU" style="flex:1;"><option value="GŒ©">GŒ©</option><option value="MŒ©">MŒ©</option></select>
                </div>
            </div>
            <div><label>Tempo</label><select id="megT"><option>30s</option><option>60s</option><option>120s</option></select></div>
        </div>
        <button class="btn-acao" onclick="addMeg()">‚ûï ADICIONAR MEDI√á√ÉO</button>
        <table id="tabMeg">
            <thead><tr><th>Ponto</th><th>Tempo</th><th>Resist√™ncia</th><th>Status</th></tr></thead>
            <tbody id="corpoMeg"></tbody>
        </table>
    </div>

    <div id="secMIC" class="glass section" style="display:none;">
        <div class="grid">
            <div><label>Fase</label><input type="text" id="micF"></div>
            <div><label>R. Medida (¬µŒ©)</label><input type="number" id="micR"></div>
            <div><label>Temp. (¬∞C)</label><input type="number" id="micTemp" value="25"></div>
            <div><label>Material</label><select id="micK"><option value="234.5">Cobre</option><option value="225">Alum√≠nio</option></select></div>
        </div>
        <button class="btn-acao" onclick="addMic()">‚ûï ADICIONAR MEDI√á√ÉO</button>
        <table id="tabMic">
            <thead><tr><th>Fase</th><th>Medido</th><th>@ 75¬∞C</th><th>Status</th></tr></thead>
            <tbody id="corpoMic"></tbody>
        </table>
    </div>

    <div id="secHIST" class="glass section" style="display:none;">
        <div id="listaHist"></div>
    </div>

    <div id="secCONFIG" class="glass section" style="display:none;">
        <div class="grid">
            <div><label>Novo T√©cnico</label><input type="text" id="cfgT"><button class="btn-acao" onclick="saveCfg('tecnicos','cfgT')">Add</button></div>
            <div><label>Novo Local</label><input type="text" id="cfgL"><button class="btn-acao" onclick="saveCfg('locais','cfgL')">Add</button></div>
        </div>
        <button class="btn-acao" style="background:var(--error); margin-top:20px; color:white;" onclick="resetBD()">LIMPAR TUDO</button>
    </div>

    <div class="no-print" style="margin-top:20px; display:flex; gap:10px;">
        <button class="btn-acao" style="background:var(--success); color:black;" onclick="salvarEnsaio()">üíæ SALVAR / ATUALIZAR TAG</button>
        <button class="btn-acao" style="background:var(--accent); color:white;" onclick="window.print()">üñ®Ô∏è IMPRIMIR RELAT√ìRIO</button>
    </div>
</div>

<script>
    const TTR_RULES = {
        "Ydn1_11_X0": { f: (u1, u2) => (u1 * 1.73205) / u2, h: ["H1-H3", "H1-H2", "H3-H1"], x: ["X1-X0", "X2-X0", "X3-X0"] },
        "Dyn1_11_X0": { f: (u1, u2) => (u1 * 1.73205) / u2, h: ["H1-H3", "H2-H1", "H3-H2"], x: ["X1-X0", "X2-X0", "X3-X0"] },
        "Ynyn0":      { f: (u1, u2) => u1 / u2, h: ["H1-H0", "H2-H0", "H3-H0"], x: ["X1-X0", "X2-X0", "X3-X0"] },
        "Yyn0_Dd0":   { f: (u1, u2) => u1 / u2, h: ["H1-H2", "H2-H3", "H3-H1"], x: ["X1-X2", "X2-X3", "X3-X1"] }
    };

    function abrirS(id) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById('sec'+id).style.display = 'block';
        if(id === 'HIST') renderHist();
    }

    // L√ìGICA TTR (RESTAURADA)
    let vTeo = 0;
    function initTTR() {
        const fas = document.getElementById('fasTTR').value;
        if(!fas) return;
        document.getElementById('corpoTTR').innerHTML = TTR_RULES[fas].h.map((h, i) => `
            <tr>
                <td><b>${h}/${TTR_RULES[fas].x[i]}</b></td>
                <td><input type="number" class="in-ttr" oninput="calcTTR()" style="width:90px"></td>
                <td class="desv-ttr">-</td>
                <td class="stat-ttr">-</td>
            </tr>
        `).join('');
        calcTTR();
    }

    function calcTTR() {
        const u1 = parseFloat(document.getElementById('u1').value);
        const u2 = parseFloat(document.getElementById('u2').value);
        const fas = document.getElementById('fasTTR').value;
        if(u1 && u2 && fas) {
            vTeo = TTR_RULES[fas].f(u1, u2);
            document.getElementById('teoResult').innerText = "RELA√á√ÉO TE√ìRICA: " + vTeo.toFixed(5);
            document.querySelectorAll('.in-ttr').forEach(input => {
                const med = parseFloat(input.value);
                const tr = input.closest('tr');
                if(med) {
                    const d = ((med - vTeo)/vTeo)*100;
                    const ok = Math.abs(d) <= 0.5;
                    tr.querySelector('.desv-ttr').innerText = d.toFixed(3) + "%";
                    tr.querySelector('.stat-ttr').innerHTML = `<span class="badge ${ok?'ok':'nok'}">${ok?'OK':'NOK'}</span>`;
                }
            });
        }
    }

    // L√ìGICA MEG√îMETRO
    function addMeg() {
        const p = document.getElementById('megP').value;
        const v = document.getElementById('megV').value;
        const u = document.getElementById('megU').value;
        const t = document.getElementById('megT').value;
        if(!v) return;
        const ok = (u === 'GŒ©' || v > 100); // Exemplo de crit√©rio
        const row = `<tr><td>${p}</td><td>${t}</td><td>${v} ${u}</td><td><span class="badge ${ok?'ok':'nok'}">${ok?'OK':'NOK'}</span></td></tr>`;
        document.getElementById('corpoMeg').innerHTML += row;
    }

    // L√ìGICA MICRO (TOP)
    function addMic() {
        const f = document.getElementById('micF').value;
        const r = parseFloat(document.getElementById('micR').value);
        const t = parseFloat(document.getElementById('micTemp').value);
        const k = parseFloat(document.getElementById('micK').value);
        if(!r) return;
        const r75 = r * (k + 75) / (k + t);
        const row = `<tr><td>${f}</td><td>${r} ¬µŒ©</td><td>${r75.toFixed(2)} ¬µŒ©</td><td><span class="badge ok">OK</span></td></tr>`;
        document.getElementById('corpoMic').innerHTML += row;
    }

    // HIST√ìRICO POR TAG
    function salvarEnsaio() {
        const tag = document.getElementById('regTag').value;
        if(!tag) return alert("Insira o TAG do Equipamento!");
        
        const obj = {
            tag,
            tec: document.getElementById('regTec').value,
            loc: document.getElementById('regLoc').value,
            dt: document.getElementById('regData').value,
            ttrHead: { u1: document.getElementById('u1').value, u2: document.getElementById('u2').value, fas: document.getElementById('fasTTR').value },
            ttrBody: document.getElementById('corpoTTR').innerHTML,
            megBody: document.getElementById('corpoMeg').innerHTML,
            micBody: document.getElementById('corpoMic').innerHTML
        };

        let hist = JSON.parse(localStorage.getItem('alpha_v4') || "[]");
        const idx = hist.findIndex(x => x.tag === tag);
        if(idx >= 0) hist[idx] = obj; else hist.push(obj);
        
        localStorage.setItem('alpha_v4', JSON.stringify(hist));
        alert("Dados vinculados ao TAG " + tag + " com sucesso!");
    }

    function renderHist() {
        const hist = JSON.parse(localStorage.getItem('alpha_v4') || "[]");
        const lista = document.getElementById('listaHist');
        lista.innerHTML = hist.reverse().map(e => `
            <div style="background:#0a0f18; padding:15px; margin-bottom:10px; border-radius:10px; border-left:4px solid var(--primary); display:flex; justify-content:space-between; align-items:center;">
                <div><b>${e.tag}</b> - ${e.loc}<br><small>Data: ${e.dt.split('-').reverse().join('/')} | Tec: ${e.tec}</small></div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-acao" style="width:40px; margin:0;" onclick="loadTag('${e.tag}')">üìÇ</button>
                    <button class="btn-acao" style="width:40px; margin:0; background:var(--error);" onclick="delTag('${e.tag}')">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }

    function loadTag(tag) {
        const hist = JSON.parse(localStorage.getItem('alpha_v4') || "[]");
        const e = hist.find(x => x.tag === tag);
        document.getElementById('regTag').value = e.tag;
        document.getElementById('regTec').value = e.tec;
        document.getElementById('regLoc').value = e.loc;
        document.getElementById('regData').value = e.dt;
        document.getElementById('u1').value = e.ttrHead.u1;
        document.getElementById('u2').value = e.ttrHead.u2;
        document.getElementById('fasTTR').value = e.ttrHead.fas;
        document.getElementById('corpoTTR').innerHTML = e.ttrBody;
        document.getElementById('corpoMeg').innerHTML = e.megBody;
        document.getElementById('corpoMic').innerHTML = e.micBody;
        abrirS('TTR');
        calcTTR();
    }

    function delTag(tag) {
        if(!confirm("Excluir TAG " + tag + "?")) return;
        let hist = JSON.parse(localStorage.getItem('alpha_v4') || "[]");
        hist = hist.filter(x => x.tag !== tag);
        localStorage.setItem('alpha_v4', JSON.stringify(hist));
        renderHist();
    }

    // CONFIG
    function saveCfg(k, id) {
        const v = document.getElementById(id).value;
        if(!v) return;
        let l = JSON.parse(localStorage.getItem('alpha_cfg_'+k) || "[]");
        l.push(v);
        localStorage.setItem('alpha_cfg_'+k, JSON.stringify(l));
        document.getElementById(id).value = "";
        loadCfgs();
    }

    function loadCfgs() {
        const t = JSON.parse(localStorage.getItem('alpha_cfg_tecnicos') || '["EQUIPE ALPHA"]');
        const l = JSON.parse(localStorage.getItem('alpha_cfg_locais') || '["USINA 01"]');
        document.querySelectorAll('.setTec').forEach(s => s.innerHTML = t.map(x => `<option>${x}</option>`).join(''));
        document.querySelectorAll('.setLoc').forEach(s => s.innerHTML = l.map(x => `<option>${x}</option>`).join(''));
    }

    function resetBD() { if(confirm("Apagar TUDO?")) { localStorage.clear(); location.reload(); } }

    window.onload = () => { loadCfgs(); document.getElementById('regData').valueAsDate = new Date(); };
</script>
</body>
</html>
