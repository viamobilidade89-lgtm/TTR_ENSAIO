<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA TTR - EQUIPE ALPHA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { 
            --cor-fundo: #0f172a; --cor-card: #1e293b; --cor-primaria: #38bdf8; 
            --cor-texto: #f8fafc; --fonte-tam: 14px;
            --anim-velocidade: 2s; /* Padrão da animação */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: var(--fonte-tam);
            background: var(--cor-fundo); color: var(--cor-texto); margin: 0; padding: 15px; transition: 0.3s; 
        }
        
        .container { max-width: 850px; margin: auto; }
        .card { background: var(--cor-card); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        
        .gaveta { 
            position: fixed; top: 0; right: -350px; width: 320px; height: 100%; 
            background: var(--cor-card); border-left: 3px solid var(--cor-primaria); 
            z-index: 1000; transition: 0.4s; padding: 20px; box-sizing: border-box; overflow-y: auto;
        }
        .gaveta.ativa { right: 0; }
        .mascara { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 999; }
        .tres-pontos { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 28px; color: var(--cor-primaria); }

        .grade { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grade { grid-template-columns: 1fr; } }

        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, select { 
            width: 100%; padding: 12px; margin: 5px 0 10px; background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: inherit; font-size: inherit; box-sizing: border-box;
        }
        
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-calc { background: var(--cor-primaria); color: #000; width: 100%; font-size: 1.1em; margin-top: 15px; }
        
        .db-manager { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed var(--cor-primaria); }
        .res-caixa { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border-top: 4px solid var(--cor-primaria); margin-top: 20px; }
        .item-historico { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid var(--cor-primaria); font-size: 0.8em; }
        
        footer { text-align: center; margin-top: 40px; font-size: 0.9em; opacity: 0.6; font-weight: bold; letter-spacing: 1px; }

        /* Animação do Título */
        .titulo-animado {
            animation-name: fadeInOut;
            animation-iteration-count: infinite;
            animation-direction: alternate; /* Faz fade-in e depois fade-out */
            animation-timing-function: ease-in-out;
        }

        @keyframes fadeInOut {
            0%   { opacity: 0.2; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="mascara" id="mascara" onclick="toggleMenu()"></div>

<div class="gaveta" id="gaveta">
    <h2 style="color:var(--cor-primaria)">⚙️ Configurações</h2>
    
    <div class="db-manager">
        <label>Cadastrar Técnico</label>
        <div style="display:flex; gap:5px">
            <input type="text" id="novoTecnico" placeholder="Nome" style="margin-bottom:0">
            <button onclick="adicionarDB('tecnicos', 'novoTecnico')" style="background:var(--cor-primaria); color:#000">+</button>
        </div>
    </div>

    <div class="db-manager">
        <label>Cadastrar Local</label>
        <div style="display:flex; gap:5px">
            <input type="text" id="novoLocal" placeholder="Local/Subestação" style="margin-bottom:0">
            <button onclick="adicionarDB('locais', 'novoLocal')" style="background:var(--cor-primaria); color:#000">+</button>
        </div>
    </div>

    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">
    
    <label>Cor de Fundo:</label> <input type="color" id="cfgBg" oninput="salvarConfig()">
    <label>Cor Destaque:</label> <input type="color" id="cfgPrim" oninput="salvarConfig()">
    
    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">
    <h3>Animação do Título</h3>
    <label>Ativar Animação:</label>
    <input type="checkbox" id="animAtiva" onchange="salvarConfig()" style="width:auto; margin-bottom:15px;">
    
    <label>Velocidade:</label>
    <select id="animVelocidade" onchange="salvarConfig()">
        <option value="1s">Rápida</option>
        <option value="2s" selected>Normal</option>
        <option value="3s">Lenta</option>
    </select>

    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">
    <h3>Histórico de Ensaios</h3>
    <div id="listaHist">Vazio.</div>
    <button onclick="limparHistorico()" style="background:#ef4444; width:100%; margin-top:10px; font-size: 11px;">LIMPAR HISTÓRICO</button>
</div>

<div class="container">
    <div class="card">
        <div class="tres-pontos" onclick="toggleMenu()">&#8942;</div>
        <header style="text-align:center; margin-bottom:20px;">
            <h1 id="tituloApp" style="margin:0; color:var(--cor-primaria)">TTR</h1>
            <p style="opacity:0.8">Equipe Alpha - Registro de Campo</p>
        </header>

        <div class="grade">
            <div>
                <label>Técnico</label>
                <select id="selTecnico"></select>
            </div>
            <div>
                <label>Local</label>
                <select id="selLocal"></select>
            </div>
        </div>

        <label>Temperatura Medida (°C)</label>
        <input id="tempMed" type="number" step="0.1" value="25">

        <div class="grade" style="margin-top:10px">
            <section>
                <h3 style="color:var(--cor-primaria)">Alta Tensão (Ω)</h3>
                <input id="ent1" type="number" step="any" placeholder="H1-H3">
                <input id="ent2" type="number" step="any" placeholder="H1-H2">
                <input id="ent3" type="number" step="any" placeholder="H2-H3">
            </section>
            <section>
                <h3 style="color:var(--cor-primaria)">Baixa Tensão (mΩ)</h3>
                <input id="sai1" type="number" step="any" placeholder="X0-X1">
                <input id="sai2" type="number" step="any" placeholder="X0-X2">
                <input id="sai3" type="number" step="any" placeholder="X0-X3">
            </section>
        </div>

        <button class="btn-calc" onclick="calcularTudo()">CALCULAR E SALVAR</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button style="flex:1; background:#475569" onclick="location.reload()">NOVO ENSAIO</button>
            <button style="flex:1; background:#4f46e5" onclick="gerarPDF()">GERAR PDF</button>
        </div>
    </div>

    <div id="areaResultados" class="grade" style="display:none; margin-top:20px;">
        <div class="res-caixa"><div id="exibirEnt"></div></div>
        <div class="res-caixa"><div id="exibirSai"></div></div>
    </div>

    <footer>PRODUCED BY ALPHA TEAM</footer>
</div>

<script>
    let dadosSalvos = null;

    function toggleMenu() {
        document.getElementById('gaveta').classList.toggle('ativa');
        document.getElementById('mascara').style.display = document.getElementById('gaveta').classList.contains('ativa') ? 'block' : 'none';
    }

    function adicionarDB(chave, idInput) {
        const input = document.getElementById(idInput);
        if(!input.value) return;
        let lista = JSON.parse(localStorage.getItem('alpha_db_' + chave) || "[]");
        lista.push(input.value);
        localStorage.setItem('alpha_db_' + chave, JSON.stringify(lista));
        input.value = "";
        carregarSelects();
    }

    function carregarSelects() {
        const tecs = JSON.parse(localStorage.getItem('alpha_db_tecnicos') || "[]");
        const locs = JSON.parse(localStorage.getItem('alpha_db_locais') || "[]");
        document.getElementById('selTecnico').innerHTML = '<option value="">Selecionar Técnico...</option>' + tecs.map(t => `<option value="${t}">${t}</option>`).join("");
        document.getElementById('selLocal').innerHTML = '<option value="">Selecionar Local...</option>' + locs.map(l => `<option value="${l}">${l}</option>`).join("");
    }

    function salvarConfig() {
        const conf = { 
            bg: document.getElementById('cfgBg').value, 
            prim: document.getElementById('cfgPrim').value,
            animAtiva: document.getElementById('animAtiva').checked,
            animVelocidade: document.getElementById('animVelocidade').value
        };
        localStorage.setItem('alpha_ttr_v6_conf', JSON.stringify(conf));
        aplicarConfig();
    }

    function aplicarConfig() {
        const c = JSON.parse(localStorage.getItem('alpha_ttr_v6_conf'));
        if(!c) { // Configurações padrão se não houver nada salvo
            document.getElementById('animAtiva').checked = true;
            document.getElementById('animVelocidade').value = "2s";
            return; 
        }

        document.documentElement.style.setProperty('--cor-fundo', c.bg);
        document.documentElement.style.setProperty('--cor-primaria', c.prim);
        
        document.getElementById('cfgBg').value = c.bg;
        document.getElementById('cfgPrim').value = c.prim;

        const titulo = document.getElementById('tituloApp');
        if (c.animAtiva) {
            titulo.classList.add('titulo-animado');
            titulo.style.animationDuration = c.animVelocidade;
        } else {
            titulo.classList.remove('titulo-animado');
            titulo.style.opacity = '1'; // Garante que fica visível quando desativado
        }
        document.getElementById('animAtiva').checked = c.animAtiva;
        document.getElementById('animVelocidade').value = c.animVelocidade;
    }

    function calcularTudo() {
        const t = parseFloat(document.getElementById('tempMed').value);
        if (isNaN(t)) { alert("Por favor, insira uma temperatura válida."); return; }

        const fator = (235 + 75) / (235 + t);
        const k = 1.5;

        const ler = (id, multi) => {
            const val = document.getElementById(id).value;
            return val === "" ? null : (parseFloat(val) * multi) * k * fator;
        };

        dadosSalvos = {
            data: new Date().toLocaleString(),
            tecnico: document.getElementById('selTecnico').value || "Não informado",
            local: document.getElementById('selLocal').value || "Não informado",
            t: t,
            ent: [ {l:"H1-H3", v: ler('ent1', 1)}, {l:"H1-H2", v: ler('ent2', 1)}, {l:"H2-H3", v: ler('ent3', 1)} ],
            sai: [ {l:"X0-X1", v: ler('sai1', 0.001)}, {l:"X0-X2", v: ler('sai2', 0.001)}, {l:"X0-X3", v: ler('sai3', 0.001)} ]
        };

        document.getElementById('areaResultados').style.display = 'grid';
        
        document.getElementById('exibirEnt').innerHTML = "<b>Alta Tensão (Ω)</b><br>" + dadosSalvos.ent.map(i => `<div>${i.l}: ${i.v ? i.v.toFixed(3) : '---'} Ω</div>`).join("");
        document.getElementById('exibirSai').innerHTML = "<b>Baixa Tensão (mΩ)</b><br>" + dadosSalvos.sai.map(i => `<div>${i.l}: ${i.v ? (i.v*1000).toFixed(3) : '---'} mΩ</div>`).join("");
        
        salvarHist();
    }

    function salvarHist() {
        let h = JSON.parse(localStorage.getItem('alpha_ttr_v6_hist') || "[]");
        h.unshift(dadosSalvos);
        localStorage.setItem('alpha_ttr_v6_hist', JSON.stringify(h.slice(0,10)));
        carregarHist();
    }

    function carregarHist() {
        const h = JSON.parse(localStorage.getItem('alpha_ttr_v6_hist') || "[]");
        document.getElementById('listaHist').innerHTML = h.map(x => `<div class="item-historico"><b>${x.data}</b><br>${x.local}</div>`).join("");
    }

    function limparHistorico() { localStorage.removeItem('alpha_ttr_v6_hist'); carregarHist(); }

    function gerarPDF() {
        if(!dadosSalvos) return alert("Calcule antes!");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("RELATÓRIO DE ENSAIO ALPHA TTR", 10, 15);
        doc.setFontSize(10);
        doc.text(`Técnico: ${dadosSalvos.tecnico} | Local: ${dadosSalvos.local}`, 10, 25);
        doc.text(`Data: ${dadosSalvos.data} | Temperatura: ${dadosSalvos.t}°C`, 10, 30);
        
        let linhas = [];
        dadosSalvos.ent.forEach(i => linhas.push([i.l, i.v ? i.v.toFixed(3) + " Ω" : "---"]));
        dadosSalvos.sai.forEach(i => linhas.push([i.l, i.v ? (i.v*1000).toFixed(3) + " mΩ" : "---"]));
        
        doc.autoTable({startY: 35, head: [['Ponto de Medição', 'Resultado Corrigido']], body: linhas});
        doc.text("PRODUCED BY ALPHA TEAM", 10, doc.lastAutoTable.finalY + 15);
        doc.save(`ALPHA_TTR_${dadosSalvos.local.replace(/\s+/g, '_')}.pdf`);
    }

    window.onload = () => { carregarSelects(); aplicarConfig(); carregarHist(); };
</script>
</body>
</html>
