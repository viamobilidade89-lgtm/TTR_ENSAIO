<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENSAIOS ALPHA - SISTEMA DE CAMPO</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #38bdf8; --success: #10b981; --error: #f43f5e; --text: #f1f5f9;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; }
        .container { max-width: 850px; margin: 0 auto; padding: 20px; }
        
        header { display: flex; justify-content: center; align-items: center; position: relative; padding: 40px 0; }
        .titulo-app { font-size: 2.2rem; font-weight: 900; color: var(--primary); letter-spacing: 4px; text-transform: uppercase; }
        .btn-config { position: absolute; right: 10px; top: 10px; background: none; border: none; color: white; font-size: 1.1rem; cursor: pointer; opacity: 0.1; transition: 0.3s; }

        .dashboard-menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 10px; }
        .icon-card { 
            background: var(--card); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; 
            padding: 45px 10px; text-align: center; cursor: pointer; transition: 0.3s;
        }
        .icon-card:hover { border-color: var(--primary); background: rgba(56, 189, 248, 0.05); }
        .icon-card i { font-size: 3rem; display: block; margin-bottom: 12px; font-style: normal; }
        .icon-card span { font-weight: 800; font-size: 0.9rem; color: var(--primary); letter-spacing: 2px; }

        .glass { background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .section { display: none; }
        .active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 15px; }
        label { display: block; font-size: 0.65rem; font-weight: 800; color: var(--primary); margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; background: #0a0f18; border: 1px solid #334155; color: white; border-radius: 6px; font-size: 0.85rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #334155; padding: 10px; text-align: center; font-size: 0.8rem; }
        th { background: #0f172a; color: var(--primary); }
        
        .status { padding: 3px 6px; border-radius: 4px; font-weight: 900; font-size: 0.65rem; border: 1px solid transparent; }
        .ok { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: var(--success); }
        .nok { background: rgba(244, 63, 94, 0.1); color: var(--error); border-color: var(--error); }
        
        .btn-action { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; margin-top: 8px; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--error); color: #fff; }
        .btn-back { background: transparent; color: white; border: 1px solid #334155; margin-bottom: 15px; padding: 6px 15px; cursor: pointer; border-radius: 4px; font-size: 0.75rem; }

        footer { text-align: center; padding: 30px; font-size: 0.7rem; opacity: 0.3; letter-spacing: 3px; font-weight: bold; }

        /* REMO√á√ÉO ABSOLUTA DOS BOT√ïES NO PDF */
        @media print {
            .no-print, .btn-action, .btn-back, .btn-config, #botoesAcao, .dashboard-menu, .icon-card, button { 
                display: none !important; 
            }
            .section { display: block !important; }
            body { background: white !important; color: black !important; }
            .container { max-width: 100%; padding: 0; }
            .glass { background: white !important; border: 1px solid #000 !important; color: black !important; box-shadow: none; margin-bottom: 15px; }
            table { border: 1px solid #000 !important; }
            th { background: #eee !important; color: black !important; border: 1px solid #000 !important; }
            td { border: 1px solid #000 !important; color: black !important; }
            .titulo-app { color: black !important; border-bottom: 3px solid black; display: block; text-align: center; font-size: 2rem; }
            input, select { border: none !important; background: transparent !important; color: black !important; font-weight: bold; appearance: none; padding: 0; }
            footer { opacity: 1; color: black !important; border-top: 1px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <button class="btn-config" onclick="abrirS('CONFIG')">‚öôÔ∏è</button>
        <div class="titulo-app">ENSAIOS ALPHA</div>
    </header>

    <div id="secHOME" class="dashboard-menu no-print active">
        <div class="icon-card" onclick="abrirS('TTR')"><i>‚ö°</i><span>TTR</span></div>
        <div class="icon-card" onclick="abrirS('MIC')"><i>üìü</i><span>MICRO</span></div>
        <div class="icon-card" onclick="abrirS('MEG')"><i>üí•</i><span>MEGGER</span></div>
        <div class="icon-card" onclick="abrirS('HIST')"><i>üìú</i><span>HIST√ìRICO</span></div>
    </div>

    <div id="dadosEquipamento" class="glass section">
        <div class="grid-inputs">
            <div><label>TAG</label><input type="text" id="regTag"></div>
            <div><label>T√©cnico</label><select id="regTec" class="setTec"></select></div>
            <div><label>Unidade</label><select id="regLoc" class="setLoc"></select></div>
            <div><label>Data</label><input type="date" id="regData"></div>
        </div>
    </div>

    <div id="secTTR" class="section">
        <button class="btn-back no-print" onclick="voltarHome()">‚Üê VOLTAR</button>
        <div class="glass">
            <div class="grid-inputs no-print">
                <div><label>U1 (Pri)</label><input type="number" id="u1" oninput="calcTTR()"></div>
                <div><label>U2 (Sec)</label><input type="number" id="u2" oninput="calcTTR()"></div>
                <div><label>Fasorial</label>
                    <select id="fasTTR" onchange="initTTR()">
                        <option value="">--</option>
                        <option value="Dyn1">Dyn1</option>
                        <option value="Dyn11">Dyn11</option>
                        <option value="Ydn1">Ydn1</option>
                        <option value="Ydn11">Ydn11</option>
                        <option value="Yyn0">Yyn0</option>
                        <option value="Ynyn0">Ynyn0</option>
                    </select>
                </div>
            </div>
            <div id="teoLabel" style="font-weight:bold; color:var(--primary); margin:10px 0;"></div>
            <table>
                <thead><tr><th>BORNES</th><th>LIDO</th><th>DESVIO %</th><th>STATUS</th></tr></thead>
                <tbody id="corpoTTR"></tbody>
            </table>
        </div>
    </div>

    <div id="secMIC" class="section">
        <button class="btn-back no-print" onclick="voltarHome()">‚Üê VOLTAR</button>
        <div class="glass">
            <div class="grid-inputs no-print">
                <div><label>Bornes</label>
                    <select id="micP">
                        <option value="H1-H3">H1-H3 (Pri)</option><option value="H1-H2">H1-H2 (Pri)</option><option value="H2-H3">H2-H3 (Pri)</option>
                        <option value="X1-X0">X1-X0 (Sec)</option><option value="X2-X0">X2-X0 (Sec)</option><option value="X3-X0">X3-X0 (Sec)</option>
                    </select>
                </div>
                <div><label>Valor</label><input type="number" id="micR"></div>
                <div><label>Unidade</label>
                    <select id="micU">
                        <option value="1e-3">nŒ©</option>
                        <option value="1" selected>¬µŒ©</option>
                        <option value="1e3">mŒ©</option>
                        <option value="1e6">Œ©</option>
                    </select>
                </div>
                <div><label>Temp (¬∞C)</label><input type="number" id="micTM" value="25"></div>
            </div>
            <button class="btn-action btn-primary no-print" onclick="addMic()">ADICIONAR LEITURA</button>
            <table>
                <thead><tr><th>BORNES</th><th>LIDO</th><th>@ 75¬∞C</th><th>STATUS</th></tr></thead>
                <tbody id="corpoMic"></tbody>
            </table>
        </div>
    </div>

    <div id="secMEG" class="section">
        <button class="btn-back no-print" onclick="voltarHome()">‚Üê VOLTAR</button>
        <div class="glass">
            <div class="grid-inputs no-print">
                <div><label>Acoplamento</label><select id="megP"><option>PRI x SEC</option><option>PRI x TERRA</option><option>SEC x TERRA</option></select></div>
                <div><label>Tempo</label><select id="megT"><option>30s</option><option>60s</option><option>120s</option></select></div>
                <div><label>Valor</label><input type="number" id="megV"></div>
                <div><label>Escala</label><select id="megU"><option value="GŒ©">GŒ©</option><option value="MŒ©">MŒ©</option></select></div>
                <div><label>M√≠nimo (GŒ©)</label><input type="number" id="megRef" value="2.0"></div>
            </div>
            <button class="btn-action btn-primary no-print" onclick="addMeg()">ADICIONAR LEITURA</button>
            <table>
                <thead><tr><th>PONTO</th><th>TEMPO</th><th>VALOR</th><th>REFER√äNCIA</th><th>STATUS</th></tr></thead>
                <tbody id="corpoMeg"></tbody>
            </table>
        </div>
    </div>

    <div id="secHIST" class="section">
        <button class="btn-back no-print" onclick="voltarHome()">‚Üê VOLTAR</button>
        <div id="listaHist"></div>
        <button class="btn-action btn-danger no-print" onclick="limparHistorico()" style="margin-top:20px;">üóëÔ∏è APAGAR TODO O HIST√ìRICO</button>
    </div>

    <div id="secCONFIG" class="section">
        <button class="btn-back no-print" onclick="voltarHome()">‚Üê VOLTAR</button>
        <div class="glass">
            <div class="grid-inputs">
                <div><label>Novo T√©cnico</label><input type="text" id="cfgT"><button onclick="saveCfg('tecnicos','cfgT')">Add</button></div>
                <div><label>Nova Unidade</label><input type="text" id="cfgL"><button onclick="saveCfg('locais','cfgL')">Add</button></div>
            </div>
        </div>
    </div>

    <div id="botoesAcao" class="section no-print" style="gap:10px;">
        <button class="btn-action btn-success" onclick="salvarTag()">üíæ SALVAR NO TAG</button>
        <button class="btn-action" style="background:#fff; color:#000;" onclick="window.print()">üñ®Ô∏è IMPRIMIR PDF</button>
    </div>
</div>

<footer>PRODUCED BY EQUIPE ALPHA</footer>

<script>
    // REVIS√ÉO DE FASORIAIS OFICIAIS
    const TTR_RULES = {
        "Dyn1":  { f: (u1, u2) => (u1 * 1.73205) / u2, p: ["H1-H3/X1-X0", "H2-H1/X2-X0", "H3-H2/X3-X0"] },
        "Dyn11": { f: (u1, u2) => (u1 * 1.73205) / u2, p: ["H1-H3/X1-X0", "H2-H1/X2-X0", "H3-H2/X3-X0"] },
        "Ydn1":  { f: (u1, u2) => (u1 * 1.73205) / u2, p: ["H1-H3/X1-X0", "H2-H1/X2-X0", "H3-H2/X3-X0"] },
        "Ydn11": { f: (u1, u2) => (u1 * 1.73205) / u2, p: ["H1-H3/X1-X0", "H2-H1/X2-X0", "H3-H2/X3-X0"] },
        "Yyn0":  { f: (u1, u2) => u1 / u2, p: ["H1-H2/X1-X2", "H2-H3/X2-X3", "H3-H1/X3-X1"] },
        "Ynyn0": { f: (u1, u2) => u1 / u2, p: ["H1-H0/X1-X0", "H2-H0/X2-X0", "H3-H0/X3-X0"] }
    };

    function abrirS(id) {
        document.querySelectorAll('.section, .dashboard-menu').forEach(s => s.classList.remove('active'));
        document.getElementById('sec'+id).classList.add('active');
        if(!['CONFIG','HIST','HOME'].includes(id)) {
            document.getElementById('dadosEquipamento').classList.add('active');
            document.getElementById('botoesAcao').classList.add('active');
            document.getElementById('botoesAcao').style.display = 'flex';
        }
        if(id === 'HIST') renderHist();
    }

    function voltarHome() {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('botoesAcao').style.display = 'none';
        document.getElementById('secHOME').classList.add('active');
    }

    function initTTR() {
        const f = document.getElementById('fasTTR').value;
        if(!f) return;
        document.getElementById('corpoTTR').innerHTML = TTR_RULES[f].p.map(p => `<tr><td>${p}</td><td><input type="number" class="in-ttr" oninput="calcTTR()" style="width:100px"></td><td class="d-ttr">-</td><td class="s-ttr">-</td></tr>`).join('');
    }

    function calcTTR() {
        const u1 = parseFloat(document.getElementById('u1').value);
        const u2 = parseFloat(document.getElementById('u2').value);
        const f = document.getElementById('fasTTR').value;
        if(u1 && u2 && f) {
            let teo = TTR_RULES[f].f(u1, u2);
            document.getElementById('teoLabel').innerText = "Rela√ß√£o Te√≥rica: " + teo.toFixed(5);
            document.querySelectorAll('.in-ttr').forEach(inp => {
                const med = parseFloat(inp.value);
                if(med) {
                    const d = ((med - teo)/teo*100).toFixed(3);
                    const ok = Math.abs(d) <= 0.5;
                    inp.closest('tr').querySelector('.d-ttr').innerText = d + "%";
                    inp.closest('tr').querySelector('.s-ttr').innerHTML = `<span class="status ${ok?'ok':'nok'}">${ok?'APROVADO':'REPROVADO'}</span>`;
                }
            });
        }
    }

    function addMic() {
        const rLido = parseFloat(document.getElementById('micR').value);
        const fatorU = parseFloat(document.getElementById('micU').value);
        const tm = parseFloat(document.getElementById('micTM').value);
        const p = document.getElementById('micP').value;
        if(!rLido || !tm) return;
        let rBase = rLido * fatorU;
        const FT = 310 / (235 + tm);
        let r75 = rBase * FT;
        if(p.startsWith('H')) r75 *= 1.5;
        let rExibicao = r75 / fatorU;
        let sigla = document.getElementById('micU').options[document.getElementById('micU').selectedIndex].text;
        document.getElementById('corpoMic').innerHTML += `<tr><td>${p}</td><td>${rLido} ${sigla}</td><td>${rExibicao.toFixed(3)} ${sigla}</td><td><span class="status ok">OK</span></td></tr>`;
    }

    function addMeg() {
        const ref = parseFloat(document.getElementById('megRef').value);
        const v = parseFloat(document.getElementById('megV').value);
        const unid = document.getElementById('megU').value;
        const valComp = (unid === 'GŒ©' ? v : v/1000);
        const ok = valComp >= ref;
        document.getElementById('corpoMeg').innerHTML += `<tr><td>${document.getElementById('megP').value}</td><td>${document.getElementById('megT').value}</td><td>${v} ${unid}</td><td>${ref} GŒ©</td><td><span class="status ${ok?'ok':'nok'}">${ok?'APROVADO':'REPROVADO'}</span></td></tr>`;
    }

    function salvarTag() {
        const tag = document.getElementById('regTag').value;
        if(!tag) return alert("ERRO: Preencha o TAG!");
        const data = {
            tag, tec: document.getElementById('regTec').value, loc: document.getElementById('regLoc').value, dt: document.getElementById('regData').value,
            u1: document.getElementById('u1').value, u2: document.getElementById('u2').value, fas: document.getElementById('fasTTR').value,
            tB: document.getElementById('corpoTTR').innerHTML, mB: document.getElementById('corpoMeg').innerHTML, miB: document.getElementById('corpoMic').innerHTML
        };
        let h = JSON.parse(localStorage.getItem('alpha_vFinal_v7') || "[]");
        const idx = h.findIndex(x => x.tag === tag);
        if(idx >= 0) h[idx] = data; else h.push(data);
        localStorage.setItem('alpha_vFinal_v7', JSON.stringify(h));
        alert("Ensaio do TAG " + tag + " salvo!");
    }

    function renderHist() {
        const h = JSON.parse(localStorage.getItem('alpha_vFinal_v7') || "[]");
        document.getElementById('listaHist').innerHTML = h.reverse().map(e => `<div class="glass" style="display:flex; justify-content:space-between; align-items:center;"><div><b>${e.tag}</b><br><small>${e.loc} | ${e.dt}</small></div><button onclick="loadTag('${e.tag}')">Ver</button></div>`).join('');
    }

    function loadTag(tag) {
        const h = JSON.parse(localStorage.getItem('alpha_vFinal_v7') || "[]");
        const e = h.find(x => x.tag === tag);
        document.getElementById('regTag').value = e.tag;
        document.getElementById('regTec').value = e.tec;
        document.getElementById('regLoc').value = e.loc;
        document.getElementById('regData').value = e.dt;
        document.getElementById('corpoTTR').innerHTML = e.tB;
        document.getElementById('corpoMeg').innerHTML = e.mB;
        document.getElementById('corpoMic').innerHTML = e.miB;
        abrirS('TTR');
    }

    function limparHistorico() {
        if(confirm("Deseja apagar todos os registros da mem√≥ria?")) {
            localStorage.removeItem('alpha_vFinal_v7');
            renderHist();
        }
    }

    function saveCfg(k, id) {
        let l = JSON.parse(localStorage.getItem('alpha_cfg_'+k) || "[]");
        l.push(document.getElementById(id).value);
        localStorage.setItem('alpha_cfg_'+k, JSON.stringify(l));
        location.reload();
    }

    window.onload = () => {
        const t = JSON.parse(localStorage.getItem('alpha_cfg_tecnicos') || '["TECNICO PADRAO"]');
        const l = JSON.parse(localStorage.getItem('alpha_cfg_locais') || '["UNIDADE ALPHA"]');
        document.querySelectorAll('.setTec').forEach(s => s.innerHTML = t.map(x => `<option>${x}</option>`).join(''));
        document.querySelectorAll('.setLoc').forEach(s => s.innerHTML = l.map(x => `<option>${x}</option>`).join(''));
        document.getElementById('regData').valueAsDate = new Date();
    };
</script>
</body>
</html>
