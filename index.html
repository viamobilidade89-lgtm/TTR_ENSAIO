<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENSAIOS ALPHA</title>
    <style>
        :root { --fundo: #0f172a; --card: #1e293b; --primaria: #38bdf8; --texto: #f8fafc; --erro: #ff4d4d; --sucesso: #00e676; }
        body { font-family: sans-serif; background: var(--fundo); color: var(--texto); margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: auto; }
        
        header { border-bottom: 2px solid var(--primaria); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .titulo-principal { color: var(--primaria); margin: 0; font-size: 1.2em; }

        .btn-menu { background: var(--card); border: 1px solid #334155; padding: 20px; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; text-align: center; }
        #menuPrincipal { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .card { background: var(--card); padding: 15px; border-radius: 12px; display: none; }
        .grade { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        label { display: block; font-size: 0.7em; color: var(--primaria); margin-bottom: 4px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; background: #0f172a; border: 1px solid #475569; color: white; border-radius: 6px; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.8em; }
        th, td { border: 1px solid #334155; padding: 8px; text-align: center; }
        th { background: #0f172a; color: var(--primaria); }

        .btn-acao { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; background: var(--primaria); color: #000; }
        .btn-voltar { background: none; border: 1px solid var(--primaria); color: var(--primaria); padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        .status-badge { padding: 2px 5px; border-radius: 4px; font-size: 0.8em; }
        .satisfatorio { background: var(--sucesso); color: #000; }
        .reprovado { background: var(--erro); color: #fff; }

        @media print { .no-print { display: none !important; } .card { display: block !important; background: white; color: black; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <button id="btnVoltar" class="btn-voltar no-print" onclick="voltar()" style="display:none;">‚¨Ö VOLTAR</button>
        <h1 id="mainTitle" class="titulo-principal">ENSAIOS ALPHA</h1>
        <button class="no-print" onclick="abrirConfig()" style="background:none; border:none; color:white; font-size:1.5em;">‚öôÔ∏è</button>
    </header>

    <div id="menuPrincipal">
        <div class="btn-menu" onclick="abrirModulo('TTR')">‚ö° TTR</div>
        <div class="btn-menu" onclick="abrirModulo('MEGGER')">üõ°Ô∏è MEG√îMETRO</div>
        <div class="btn-menu" onclick="abrirModulo('MICRO')">üîç MICRO</div>
        <div class="btn-menu" onclick="abrirModulo('HISTORICO')" style="border-color: #fbbf24; color: #fbbf24;">üìú HIST√ìRICO</div>
    </div>

    <div id="modCONFIG" class="card">
        <label>Novo T√©cnico</label>
        <input type="text" id="cfgTec">
        <button class="btn-acao" onclick="salvarItem('tecnicos', 'cfgTec')">Adicionar T√©cnico</button>
        <br><br>
        <label>Novo Local</label>
        <input type="text" id="cfgLoc">
        <button class="btn-acao" onclick="salvarItem('locais', 'cfgLoc')">Adicionar Local</button>
        <button class="btn-acao" onclick="resetar()" style="background:var(--erro); margin-top:30px; color:white;">APAGAR TUDO</button>
    </div>

    <div id="modMEGGER" class="card">
        <div class="grade">
            <div><label>T√©cnico</label><select class="selTec"></select></div>
            <div><label>Local</label><select class="selLoc"></select></div>
        </div>
        <div class="grade">
            <div style="grid-column: span 2;">
                <label>Ponto de Medi√ß√£o</label>
                <select id="pontoMeg">
                    <option>PRIM√ÅRIO X SECUND√ÅRIO</option>
                    <option>PRIM√ÅRIO X CARCA√áA</option>
                    <option>SECUND√ÅRIO X CARCA√áA</option>
                    <option>ENTRADA X SA√çDA</option>
                    <option>ENTRADA X CARCA√áA</option>
                    <option>SA√çDA X CARCA√áA</option>
                </select>
            </div>
        </div>
        <div class="grade">
            <div><label>30s (GŒ©)</label><input type="number" id="m30"></div>
            <div><label>60s (GŒ©)</label><input type="number" id="m60"></div>
            <div><label>120s (GŒ©)</label><input type="number" id="m120"></div>
        </div>
        <button class="btn-acao no-print" onclick="addMeg()">‚ûï ADICIONAR MEDI√á√ÉO</button>
        <table id="tabMeg">
            <thead><tr><th>Ponto</th><th>30s</th><th>60s</th><th>120s</th><th>IA</th><th>IP</th></tr></thead>
            <tbody id="corpoMeg"></tbody>
        </table>
        <button class="btn-acao no-print" onclick="salvarEnsaio('MEGGER')" style="background:#fbbf24;">üíæ SALVAR ENSAIO</button>
    </div>

    <div id="modTTR" class="card">
        <div class="grade">
            <div><label>U1 (V)</label><input type="number" id="u1" oninput="calcTTR()"></div>
            <div><label>U2 (V)</label><input type="number" id="u2" oninput="calcTTR()"></div>
        </div>
        <label>Fasorial</label>
        <select id="selFas" onchange="iniciarTTR()">
            <option value="">-- SELECIONE --</option>
            <option value="Ydn1_11_X0">Ydn1/Ydn11 (C/ X0)</option>
            <option value="Dyn1_11_X0">Dyn1/Dyn11 (C/ X0)</option>
            <option value="Ynyn0">Ynyn0 (Direto)</option>
            <option value="Yyn0_Dd0">Yyn0 ou Dd0 (Direto)</option>
        </select>
        <div id="resTeo" style="text-align:center; padding:10px; color:var(--primaria); font-weight:bold;"></div>
        <table id="tabTTR">
            <thead><tr><th>Bornes</th><th>Medido</th><th>Desvio %</th></tr></thead>
            <tbody id="corpoTTR"></tbody>
        </table>
        <button class="btn-acao no-print" onclick="salvarEnsaio('TTR')" style="background:#fbbf24;">üíæ SALVAR ENSAIO</button>
    </div>

    <div id="modHISTORICO" class="card">
        <div id="listaHist"></div>
    </div>

</div>

<script>
    const REGRAS = {
        "Ydn1_11_X0": { f: (u1, u2) => (u1 * 1.73205) / u2, h: ["H1-H3", "H1-H2", "H3-H1"], x: ["X1-X0", "X2-X0", "X3-X0"] },
        "Dyn1_11_X0": { f: (u1, u2) => (u1 * 1.73205) / u2, h: ["H1-H3", "H2-H1", "H3-H2"], x: ["X1-X0", "X2-X0", "X3-X0"] },
        "Ynyn0":      { f: (u1, u2) => u1 / u2, h: ["H1-H0", "H2-H0", "H3-H0"], x: ["X1-X0", "X2-X0", "X3-X0"] },
        "Yyn0_Dd0":   { f: (u1, u2) => u1 / u2, h: ["H1-H2", "H2-H3", "H3-H1"], x: ["X1-X2", "X2-X3", "X3-X1"] }
    };

    function abrirModulo(id) {
        document.getElementById('menuPrincipal').style.display = 'none';
        document.getElementById('btnVoltar').style.display = 'block';
        document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
        document.getElementById('mod' + id).style.display = 'block';
        if(id === 'HISTORICO') renderizarHist();
    }

    function voltar() {
        document.getElementById('menuPrincipal').style.display = 'grid';
        document.getElementById('btnVoltar').style.display = 'none';
        document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
    }

    function abrirConfig() { abrirModulo('CONFIG'); }

    // --- MEGOMETRO ---
    function addMeg() {
        const p = document.getElementById('pontoMeg').value;
        const m30 = parseFloat(document.getElementById('m30').value) || 0;
        const m60 = parseFloat(document.getElementById('m60').value) || 0;
        const m120 = parseFloat(document.getElementById('m120').value) || 0;
        const ia = m30 > 0 ? (m60/m30).toFixed(2) : "-";
        const ip = m60 > 0 ? (m120/m60).toFixed(2) : "-";
        
        const tr = `<tr><td>${p}</td><td>${m30}</td><td>${m60}</td><td>${m120}</td><td>${ia}</td><td>${ip}</td></tr>`;
        document.getElementById('corpoMeg').innerHTML += tr;
    }

    // --- TTR ---
    let vTeo = 0;
    function iniciarTTR() {
        const fas = document.getElementById('selFas').value;
        if(!fas) return;
        document.getElementById('corpoTTR').innerHTML = REGRAS[fas].h.map((h, i) => 
            `<tr><td>${h}/${REGRAS[fas].x[i]}</td><td><input type="number" class="in-ttr" oninput="calcTTR()" style="width:80px"></td><td class="desv">-</td></tr>`
        ).join("");
        calcTTR();
    }
    function calcTTR() {
        const u1 = parseFloat(document.getElementById('u1').value);
        const u2 = parseFloat(document.getElementById('u2').value);
        const fas = document.getElementById('selFas').value;
        if(u1 && u2 && fas) {
            vTeo = REGRAS[fas].f(u1, u2);
            document.getElementById('resTeo').innerText = "TE√ìRICO: " + vTeo.toFixed(5);
            document.querySelectorAll('.in-ttr').forEach(input => {
                const med = parseFloat(input.value);
                if(med) {
                    const d = ((med - vTeo)/vTeo*100).toFixed(3);
                    input.closest('tr').querySelector('.desv').innerText = d + "%";
                }
            });
        }
    }

    // --- BANCO DE DADOS ---
    function salvarItem(chave, idInput) {
        const val = document.getElementById(idInput).value;
        if(!val) return;
        let lista = JSON.parse(localStorage.getItem(chave) || "[]");
        lista.push(val);
        localStorage.setItem(chave, JSON.stringify(lista));
        document.getElementById(idInput).value = "";
        carregarSelects();
    }

    function carregarSelects() {
        const tecs = JSON.parse(localStorage.getItem('tecnicos') || '["EQUIPE ALPHA"]');
        const locs = JSON.parse(localStorage.getItem('locais') || '["SEDE"]');
        document.querySelectorAll('.selTec').forEach(s => s.innerHTML = tecs.map(t => `<option>${t}</option>`).join(""));
        document.querySelectorAll('.selLoc').forEach(s => s.innerHTML = locs.map(l => `<option>${l}</option>`).join(""));
    }

    function salvarEnsaio(tipo) {
        const hist = JSON.parse(localStorage.getItem('alpha_hist') || "[]");
        const dados = { id: Date.now(), tipo, data: new Date().toLocaleString() };
        hist.push(dados);
        localStorage.setItem('alpha_hist', JSON.stringify(hist));
        alert("Ensaio salvo com sucesso!");
    }

    function renderizarHist() {
        const hist = JSON.parse(localStorage.getItem('alpha_hist') || "[]");
        const lista = document.getElementById('listaHist');
        lista.innerHTML = hist.reverse().map(e => `
            <div style="background:#0f172a; padding:10px; margin-bottom:10px; border-radius:8px; border-left:4px solid var(--primaria);">
                <b>${e.tipo}</b> <br> <small>${e.data}</small>
            </div>
        `).join("");
    }

    function resetar() { if(confirm("Apagar tudo?")) { localStorage.clear(); location.reload(); } }

    window.onload = carregarSelects;
</script>
</body>
</html>
